<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../../assets/ico/favicon.ico">

    <title>City of Raleigh SSO's</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="../ssoform/dist/css/style.css" />
    <link  href="../ssoform/leaflet-0.7.2/leaflet.css" rel="stylesheet"/>
    <link href="../ssoform/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../ssoform/Leaflet.markercluster-master/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="../ssoform/Leaflet.markercluster-master/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="../ssoform/dist/css/l.geosearch.css" />
    <link rel="shortcut icon" href="../ssoform/dist/img/favicon.ico" />
    <link rel="icon" type="image/ico" href="../ssoform/dist/img/favicon.ico" />


    <!-- Custom styles for this template -->
   

    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top" style="background-color:#5c8fea;" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" style="color:white;" href="../devApp/DevPlanSearch.html">City of Raleigh SSO's</a>
        </div>
        <div class="navbar-collapse collapse">
        </div><!--/.navbar-collapse -->
      </div>
    </div>

        
          <div id="map" ></div>
    <!-- Main jumbotron for a primary marketing message or call to action -->
    



    <!--<script src="http://js.arcgis.com/3.9/"></script>-->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.12.0/jquery.validate.min.js"></script>
    <script src="../ssoform/dist/js/bootstrap.min.js"></script>
    <script src="../ssoform/dist/js/bootbox.min.js"></script>
    <script src="../ssoform/leaflet-0.7.2/leaflet.js"></script>
    <script src="../ssoform/esri-leaflet-master/dist/esri-leaflet.js" type="text/javascript"></script>
    <script src="../ssoform/Leaflet.markercluster-master/dist/leaflet.markercluster-src.js" type="text/javascript"></script>
    <script src="../ssoform/esri-leaflet-master/dist/extras/clustered-feature-layer.js" type="text/javascript"></script>
    <script src="../ssoform/dist/js/l.control.geosearch.js" type="text/javascript"></script>
    <script src="../ssoform/dist/js/l.geosearch.provider.google.js" type="text/javascript"></script>
    <script src="../ssoform/dist/js/leaflet-hash.js"></script>
    <script src="../ssoform/dist/js/form.js"></script>
    <script type="text/javascript">

    //Main map and Basemaps
    var map = L.map('map').setView([35.843768,-78.6450559], 11);
    var hash = new L.Hash(map);
    var streets =  L.esri.basemapLayer("Streets").addTo(map);
    var Orthos2013 = L.esri.basemapLayer("Imagery");

    //Initiate Geocoder
    var GeoCoder = new L.Control.GeoSearch({
    provider: new L.GeoSearch.Provider.Google(),
    position: 'topcenter',
    showMarker: true
    }).addTo(map);


    function popup (feature, layer) {
    layer.bindPopup("<h4>Sanitary System Overflow</h4>" + "<h5>Address: <small>" + feature.properties.ADDRESS + "</small></h5><h5>Duration: <small>" + feature.properties.DURATION +  "</small></h5><h5>Fish Kill: <small>" + feature.properties.FISH_KILL + "</small></h5><h5>Estimated Gallons: <small>" + feature.properties.EST_GALLON + "</small></h4><h4>Cause: <small>" + feature.properties.CAUSE_SPIL + "</small></h5><h5>Tributary: <small>" + feature.properties.TRIBUTARY  + "</small></h5>" )
  }

  function markerToLayer (feature, latlng){
    return L.circleMarker(latlng, {
    fillColor: '#63B355',
    radius: 4,
    color: '#63B355',
    weight: 1,
    fillOpacity: 1
  });
}

var popupOptions = { minWidth: 800, maxWidth: 3000,  keepInView: true}


function findMidpoint (A, B){
  var x = ((A[0] + B[0])/2);
  var y = ((A[1] + B[1])/2);
  init.post.geometry['x'] = x;
  init.post.geometry['y'] = y; 
}

// $('#updater',init.formframe).append('<h4>Manholes/h4><h5>FACILITYID: <small>')   
// var str = init.formframe.prop('innerHTML');
// alert(str)

map.on('dblclick', function(e){ 
 var newSSO = L.circleMarker(e.latlng, {
    fillColor: '#63B355',
    radius: 4,
    color: '#63B355',
    weight: 1,
    fillOpacity: 1
  }).addTo(map);
var str = init.formframe.prop('innerHTML');
  init.innerpopup = str;
  init.post.geometry['x'] = e.latlng.lng;
  init.post.geometry['y'] = e.latlng.lat;
  var popup = L.popup(popupOptions)
        .setContent(init.innerpopup);


        
  newSSO.bindPopup(popup); 
  popup.update()
  newSSO.openPopup();
});




function form(feature, layer){
  
  $("#ADDRESS", init.formframe).attr('value', getAddress());
  $("#BASIN", init.formframe).attr('value', feature.properties.BASIN);
  $("#PIPE_DIAM", init.formframe).attr('value', feature.properties.DIAMETER);
  $("#PIPEMATERI", init.formframe).attr('value', feature.properties.MATERIAL);
  $("#LASTCLEANDATE", init.formframe).attr('value', getCurrentDate());
  $("#SSO_DATE", init.formframe).attr('value', getCurrentDate());
  $("#FACILITYID", init.formframe).attr('value', feature.properties.FACILITYID);
  $("#CITY", init.formframe).attr('value', feature.properties.JURISDICTION);
  var str = init.formframe.prop('innerHTML');
  init.innerpopup = str;
        if (feature.geometry.coordinates[0].length > 1){
          findMidpoint(feature.geometry.coordinates[0], feature.geometry.coordinates[1])
        }
        else{
          init.post.geometry['x'] = feature.geometry.coordinates[0]
          init.post.geometry['y'] = feature.geometry.coordinates[1]
          
        }



  var popup = L.popup(popupOptions)
        .setContent(init.innerpopup);
        


        
  layer.bindPopup(popup); 
  popup.update()


}


function manholeMarker (feature, latlng){
  var manholeIcon = L.icon({
    iconUrl: '../ssoform/leaflet-0.7.2/images/manhole-icon-green.png',
    iconRetinaUrl: '../ssoform/leaflet-0.7.2/images/manhole-icon-green.png',
    shadowUrl: '../ssoform/leaflet-0.7.2/images/marker-shadow.png' 
});
  return L.marker(latlng, {
      icon: manholeIcon
    });
  }


function pipeStyles (color){
var style = {
    "color": color,
    "weight": 5,
    "opacity": 0.65,
    "lineCap": "butt"
  }
return style
}

    var sso = L.esri.featureLayer('http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/DataCollection/MapServer/0',
                     {onEachFeature: popup,
                      pointToLayer: markerToLayer 
                    });

    var gravitymains = L.esri.featureLayer('http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/SewerCollection/MapServer/11',
                     {
                        onEachFeature: form,
                        style: pipeStyles("#8EF13C")
                     // pointToLayer: markerToLayer1 
                     });
    var forcemains = L.esri.featureLayer('http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/SewerCollection/MapServer/12',
                     {
                        onEachFeature: form,
                        style: pipeStyles('#A60000')
                     // pointToLayer: markerToLayer1 
                     });
    var laterals = L.esri.featureLayer('http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/SewerCollection/MapServer/14',
                     {
                        onEachFeature: form,
                        style: pipeStyles('#078600')
                     // pointToLayer: markerToLayer1 
                     });



   var manholes = L.esri.clusteredFeatureLayer('http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/SewerCollection/MapServer/5', {onEachMarker: form, createMarker: manholeMarker}).addTo(map);
    
     var baseLayers = {
    "Streets": streets,
    "2013 Orthos": Orthos2013
    };

    var overlays = {
    "SSO's": sso,
    "Manholes": manholes,
    "Gravity Mains": gravitymains,
    "Force Mains": forcemains,
    "Laterals": laterals
};

L.control.layers(baseLayers, overlays).addTo(map);   
 </script> 
</body>
</html>
 

  
        